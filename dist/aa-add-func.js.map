{"version":3,"sources":["../src/aa-add-func.js"],"names":["getAllFunctionNames","categories","_","reduce","list","category","each","func","push","name","createFunctionDropDownMenu","map","text","submenu","value","click","aaAddFunc","$compile","inputTemplate","buttonTemplate","link","$scope","elem","aafunc","getCategories","allFunctions","functionMenu","$input","$button","appendTo","attr","typeahead","source","minLength","items","updater","funcDef","getFuncDef","lowerValue","toLowerCase","find","funcName","indexOf","undefined","$apply","addFunction","trigger","hide","show","focus","keyup","toggleClass","val","blur","setTimeout","removeClass","contents","coreModule","directive"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\n\nimport coreModule from 'app/core/core_module';\nimport * as aafunc from './aafunc';\n\nfunction getAllFunctionNames(categories) {\n  return _.reduce(categories, (list, category) => {\n    _.each(category, (func) => list.push(func.name));\n    return list;\n  }, []);\n}\n\nfunction createFunctionDropDownMenu(categories) {\n  return _.map(categories, (list, category) => (\n    {\n      text: category,\n      submenu: _.map(list, (value) => (\n        {\n          text: value.name,\n          click: `ctrl.addFunction('${value.name}')`,\n        }\n      )),\n    }\n  ));\n}\n\n/** @ngInject */\nexport function aaAddFunc($compile) {\n  const inputTemplate = '<input type=\"text\"'\n                        + ' class=\"gf-form-input\"'\n                        + ' spellcheck=\"false\" style=\"display:none\"></input>';\n\n  const buttonTemplate = '<a  class=\"gf-form-label tight-form-func dropdown-toggle query-part\"'\n                         + ' tabindex=\"1\" gf-dropdown=\"functionMenu\" data-toggle=\"dropdown\">'\n                         + '<i class=\"fa fa-plus\"></i></a>';\n\n\n  return {\n    link: ($scope, elem) => {\n      const categories = aafunc.getCategories();\n      const allFunctions = getAllFunctionNames(categories);\n\n      $scope.functionMenu = createFunctionDropDownMenu(categories);\n\n      const $input = $(inputTemplate);\n      const $button = $(buttonTemplate);\n      $input.appendTo(elem);\n      $button.appendTo(elem);\n\n      $input.attr('data-provide', 'typeahead');\n      $input.typeahead({\n        source: allFunctions,\n        minLength: 1,\n        items: 10,\n        updater: (value) => {\n          let funcDef = aafunc.getFuncDef(value);\n          if (!funcDef) {\n            // try find close match\n            const lowerValue = value.toLowerCase();\n            funcDef = _.find(allFunctions, (funcName) => (\n              funcName.toLowerCase().indexOf(lowerValue) === 0\n            ));\n\n            if (!funcDef) { return undefined; }\n          }\n\n          $scope.$apply(() => {\n            $scope.addFunction(funcDef);\n          });\n\n          $input.trigger('blur');\n          return '';\n        },\n      });\n\n      $button.click(() => {\n        $button.hide();\n        $input.show();\n        $input.focus();\n      });\n\n      $input.keyup(() => {\n        elem.toggleClass('open', $input.val() === '');\n      });\n\n      $input.blur(() => {\n        // clicking the function dropdown menu won't\n        // work if you remove class at once\n        setTimeout(() => {\n          $input.val('');\n          $input.hide();\n          $button.show();\n          elem.removeClass('open');\n        }, 200);\n      });\n\n      $compile(elem.contents())($scope);\n    },\n  };\n}\n\ncoreModule.directive('aaAddFunc', aaAddFunc);\n"],"file":"aa-add-func.js"}