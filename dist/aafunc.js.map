{"version":3,"sources":["../src/aafunc.js"],"names":["index","categories","Transform","addFuncDef","funcDef","params","defaultParams","category","push","name","shortName","type","FuncInstance","def","slice","updateText","metricFunctions","func","bindedFunc","param","i","length","Number","_","partial","message","metricExp","str","parameters","map","value","paramType","$","isNumeric","unshift","join","strValue","indexOf","optional","_hasMultipleParamsInString","each","split","partVal","idx","updateParam","trim","splice","text","createFuncInstance","isString","getFuncDef","getCategories"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\n\nvar index = [];\nvar categories = {\n  Transform: [],\n};\n\nfunction addFuncDef(funcDef) {\n  funcDef.params = funcDef.params || [];\n  funcDef.defaultParams = funcDef.defaultParams || [];\n\n  if (funcDef.category) {\n    categories[funcDef.category].push(funcDef);\n  }\n  index[funcDef.name] = funcDef;\n  index[funcDef.shortName || funcDef.name] = funcDef;\n}\n\n// Transform\n\naddFuncDef({\n  name: 'multiply',\n  category: 'Transform',\n  params: [\n    {name: 'number', type: 'float'},\n  ],\n  defaultParams: [1]\n});\n\nclass FuncInstance {\n  constructor(funcDef, params) {\n    this.def = funcDef;\n\n    if (params) {\n      this.params = params;\n    } else {\n      // Create with default params\n      this.params = [];\n      this.params = funcDef.defaultParams.slice(0);\n    }\n\n    this.updateText();\n  }\n\n  bindFunction(metricFunctions) {\n    var func = metricFunctions[this.def.name];\n    if (func) {\n\n      // Bind function arguments\n      var bindedFunc = func;\n      var param;\n      for (var i = 0; i < this.params.length; i++) {\n        param = this.params[i];\n\n        // Convert numeric params\n        if (this.def.params[i].type === 'int' ||\n            this.def.params[i].type === 'float') {\n          param = Number(param);\n        }\n        bindedFunc = _.partial(bindedFunc, param);\n      }\n      return bindedFunc;\n    } else {\n      throw { message: 'Method not found ' + this.def.name };\n    }\n  }\n\n  render(metricExp) {\n    var str = this.def.name + '(';\n    var parameters = _.map(this.params, function(value, index) {\n\n      var paramType = this.def.params[index].type;\n      if (paramType === 'int' ||\n          paramType === 'float' ||\n          paramType === 'value_or_series' ||\n          paramType === 'boolean') {\n        return value;\n      }\n      else if (paramType === 'int_or_interval' && $.isNumeric(value)) {\n        return value;\n      }\n\n      return \"'\" + value + \"'\";\n\n    }, this);\n\n    if (metricExp) {\n      parameters.unshift(metricExp);\n    }\n\n    return str + parameters.join(', ') + ')';\n  }\n\n  _hasMultipleParamsInString(strValue, index) {\n    if (strValue.indexOf(',') === -1) {\n      return false;\n    }\n\n    return this.def.params[index + 1] && this.def.params[index + 1].optional;\n  }\n\n  updateParam(strValue, index) {\n    // handle optional parameters\n    // if string contains ',' and next param is optional, split and update both\n    if (this._hasMultipleParamsInString(strValue, index)) {\n      _.each(strValue.split(','), function(partVal, idx) {\n        this.updateParam(partVal.trim(), idx);\n      }, this);\n      return;\n    }\n\n    if (strValue === '' && this.def.params[index].optional) {\n      this.params.splice(index, 1);\n    }\n    else {\n      this.params[index] = strValue;\n    }\n\n    this.updateText();\n  }\n\n  updateText() {\n    if (this.params.length === 0) {\n      this.text = this.def.name + '()';\n      return;\n    }\n\n    var text = this.def.name + '(';\n    text += this.params.join(', ');\n    text += ')';\n    this.text = text;\n  }\n}\n\nexport function createFuncInstance(funcDef, params) {\n  if (_.isString(funcDef)) {\n    if (!index[funcDef]) {\n      throw { message: 'Method not found ' + name };\n    }\n    funcDef = index[funcDef];\n  }\n  return new FuncInstance(funcDef, params);\n}\n\nexport function getFuncDef(name) {\n  return index[name];\n}\n\nexport function getCategories() {\n  return categories;\n}\n\n"],"file":"aafunc.js"}