{"version":3,"sources":["../src/datasource.js"],"names":["ArchiverapplianceDatasource","instanceSettings","backendSrv","templateSrv","type","url","name","withCredentials","headers","basicAuth","length","Authorization","operatorList","options","query","buildQueryParameters","targets","_","filter","t","hide","Promise","resolve","data","targetProcesses","map","target","targetProcess","all","then","timeseriesDataArray","postProcess","buildUrls","urls","doMultiUrlRequests","responses","responseParse","timeseriesData","setAlias","applyFunctions","flatten","maxNumPVs","binInterval","interval","targetPVs","parseTargetPV","pvnamesPromise","targetPV","regex","pvNamesFindQuery","pvnamesArray","reject","pvnames","slice","uniq","pvname","buildUrl","operator","from","to","e","pv","includes","undefined","Error","encodeURIComponent","toISOString","requests","doRequest","method","timeSeriesDataArray","response","timeSeriesData","targetRes","timesiries","datapoint","val","secs","floor","nanos","timeseries","meta","datapoints","alias","pattern","aliasPattern","RegExp","newTimeseriesData","replace","functions","applyFunctionDefs","status","message","title","maxPvs","res","replacedQuery","split","pvQuery","paramsQuery","parsedPVs","limitNum","params","URLSearchParams","has","limit","parseInt","get","Number","isInteger","targetQuery","text","newOptions","result","datasourceRequest","Date","range","rangeMsec","getTime","intervalSec","maxDataPoints","String","func","newFunc","param","scopedVars","refId","getOptions","splitQueries","queries","forEach","splitQuery","i","orElems","trim","newQueries","orElem","functionDefs","categories","applyFuncDefs","pickFuncDefsFromCategories","promises","reduce","prevPromise","funcInstance","aafunc","createFuncInstance","def","bindedFunc","bindFunction","dataProcessor","aaFunctions","appliedOptionFuncs","optionMap","allCategorisedFuncDefs","getCategories","requiredCategoryFuncNames","funcNames","category","concat","pickedFuncDefs"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport dataProcessor from './dataProcessor';\nimport * as aafunc from './aafunc';\n\n/*\n * Variable format descriptions\n * ---\n * timeseries = {\n *   \"target\":\"PV1\", // Used as legend in Grafana\n *   \"datapoints\":[\n *     [622, 1450754160000], // Metric value as a float, unixtimestamp in milliseconds\n *     [365, 1450754220000]\n *   ]\n * }\n * timeseriesData = [ timeseries, timeseries, ... ]\n * timeseriesDataArray = [ timeseriesData, timeseriesData, ... ]\n */\n\nexport class ArchiverapplianceDatasource {\n  constructor(instanceSettings, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = { 'Content-Type': 'application/json' };\n    if (\n      typeof instanceSettings.basicAuth === 'string'\n      && instanceSettings.basicAuth.length > 0\n    ) {\n      this.headers.Authorization = instanceSettings.basicAuth;\n    }\n\n    this.operatorList = [\n      'firstSample', 'lastSample', 'firstFill', 'lastFill', 'mean', 'min',\n      'max', 'count', 'ncount', 'nth', 'median', 'std', 'jitter',\n      'ignoreflyers', 'flyers', 'variance',\n      'popvariance', 'kurtosis', 'skewness', 'raw',\n    ];\n  }\n\n  // Called from Grafana panels to get data\n  query(options) {\n    const query = this.buildQueryParameters(options);\n\n    // Remove hidden target from query\n    query.targets = _.filter(query.targets, (t) => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return Promise.resolve({ data: [] });\n    }\n\n    const targetProcesses = _.map(query.targets, (target) => (\n      this.targetProcess(target)\n    ));\n\n    return (\n      Promise.all(targetProcesses)\n        .then((timeseriesDataArray) => this.postProcess(timeseriesDataArray))\n    );\n  }\n\n  targetProcess(target) {\n    return (\n      this.buildUrls(target)\n        .then((urls) => this.doMultiUrlRequests(urls))\n        .then((responses) => this.responseParse(responses))\n        .then((timeseriesData) => this.setAlias(timeseriesData, target))\n        .then((timeseriesData) => this.applyFunctions(timeseriesData, target))\n    );\n  }\n\n  postProcess(timeseriesDataArray) {\n    const timeseriesData = _.flatten(timeseriesDataArray);\n\n    return { data: timeseriesData };\n  }\n\n  buildUrls(target) {\n    // Get Option values\n    const maxNumPVs = target.options.maxNumPVs || 100;\n    const binInterval = target.options.binInterval || target.interval;\n\n    const targetPVs = this.parseTargetPV(target.target);\n\n    // Create Promise to fetch PV names\n    const pvnamesPromise = _.map(targetPVs, (targetPV) => {\n      if (target.regex) {\n        return this.pvNamesFindQuery(targetPV, maxNumPVs);\n      }\n\n      return Promise.resolve([targetPV]);\n    });\n\n    return Promise.all(pvnamesPromise)\n      .then((pvnamesArray) => (\n        new Promise((resolve, reject) => {\n          const pvnames = _.slice(_.uniq(_.flatten(pvnamesArray)), 0, maxNumPVs);\n          let urls;\n\n          try {\n            urls = _.map(pvnames, (pvname) => (\n              this.buildUrl(\n                pvname,\n                target.operator,\n                binInterval,\n                target.from,\n                target.to,\n              )\n            ));\n          } catch (e) {\n            reject(e);\n          }\n\n          resolve(urls);\n        })\n      ));\n  }\n\n  buildUrl(pvname, operator, interval, from, to) {\n    const pv = (() => {\n      // raw Operator\n      if (operator === 'raw' || interval === '') {\n        return `${pvname}`;\n      }\n\n      // Default Operator\n      if (_.includes(['', undefined], operator)) {\n        return `mean_${interval}(${pvname})`;\n      }\n\n      // Other Operator\n      if (_.includes(this.operatorList, operator)) {\n        return `${operator}_${interval}(${pvname})`;\n      }\n\n      throw new Error('Data Processing Operator is invalid.');\n    })();\n\n    const url = `${this.url}/data/getData.json?pv=${encodeURIComponent(pv)}&from=${from.toISOString()}&to=${to.toISOString()}`;\n\n    return url;\n  }\n\n  doMultiUrlRequests(urls) {\n    const requests = _.map(urls, (url) => (\n      this.doRequest({ url, method: 'GET' })\n    ));\n\n    return Promise.all(requests);\n  }\n\n  responseParse(responses) {\n    const timeSeriesDataArray = _.map(responses, (response) => {\n      const timeSeriesData = _.map(response.data, (targetRes) => {\n        const timesiries = _.map(targetRes.data, (datapoint) => (\n          [\n            datapoint.val,\n            datapoint.secs * 1000 + _.floor(datapoint.nanos / 1000000),\n          ]\n        ));\n        const timeseries = { target: targetRes.meta.name, datapoints: timesiries };\n        return timeseries;\n      });\n      return timeSeriesData;\n    });\n\n    return Promise.resolve(_.flatten(timeSeriesDataArray));\n  }\n\n  setAlias(timeseriesData, target) {\n    if (!target.alias) {\n      return Promise.resolve(timeseriesData);\n    }\n\n    let pattern;\n    if (target.aliasPattern) {\n      pattern = new RegExp(target.aliasPattern, '');\n    }\n\n    const newTimeseriesData = _.map(timeseriesData, (timeseries) => {\n      if (pattern) {\n        const alias = timeseries.target.replace(pattern, target.alias);\n        return { target: alias, datapoints: timeseries.datapoints };\n      }\n\n      return { target: target.alias, datapoints: timeseries.datapoints };\n    });\n\n    return Promise.resolve(newTimeseriesData);\n  }\n\n  applyFunctions(timeseriesData, target) {\n    if (target.functions === undefined) {\n      return Promise.resolve(timeseriesData);\n    }\n\n    return this.applyFunctionDefs(target.functions, ['Transform', 'Filter Series'], timeseriesData);\n  }\n\n  // Called from Grafana data source configuration page to make sure the connection is working\n  testDatasource() {\n    return { status: 'success', message: 'Data source is working', title: 'Success' };\n  }\n\n  pvNamesFindQuery(query, maxPvs) {\n    if (!query) {\n      return Promise.resolve([]);\n    }\n\n    const url = `${this.url}/bpl/getMatchingPVs?limit=${maxPvs}&regex=${encodeURIComponent(query)}`;\n\n    return this.doRequest({\n      url,\n      method: 'GET',\n    }).then((res) => res.data);\n  }\n\n  // Called from Grafana variables to get values\n  metricFindQuery(query) {\n    /*\n     * query format:\n     * ex1) PV:NAME:.*\n     * ex2) PV:NAME:.*?limit=10\n     */\n    const replacedQuery = this.templateSrv.replace(query, null, 'regex');\n    const [pvQuery, paramsQuery] = replacedQuery.split('?', 2);\n    const parsedPVs = this.parseTargetPV(pvQuery);\n\n    // Parse query parameters\n    let limitNum = 100;\n    if (paramsQuery) {\n      const params = new URLSearchParams(paramsQuery);\n      if (params.has('limit')) {\n        const limit = parseInt(params.get('limit'), 10);\n        limitNum = Number.isInteger(limit) ? limit : 100;\n      }\n    }\n\n    const pvnamesPromise = _.map(parsedPVs, (targetQuery) => (\n      this.pvNamesFindQuery(targetQuery, limitNum)\n    ));\n\n    return Promise.all(pvnamesPromise).then((pvnamesArray) => {\n      const pvnames = _.slice(_.uniq(_.flatten(pvnamesArray)), 0, limitNum);\n      return _.map(pvnames, (pvname) => ({ text: pvname }));\n    });\n  }\n\n  doRequest(options) {\n    const newOptions = { ...options };\n    newOptions.withCredentials = this.withCredentials;\n    newOptions.headers = this.headers;\n\n    const result = this.backendSrv.datasourceRequest(newOptions);\n    return result;\n  }\n\n  buildQueryParameters(options) {\n    /*\n     * options argument format\n     * ---\n     * {\n     *   ...\n     *   \"range\": { \"from\": \"2015-12-22T03:06:13.851Z\", \"to\": \"2015-12-22T06:48:24.137Z\" },\n     *   \"interval\": \"5s\",\n     *   \"targets\": [\n     *     { \"refId\":\"A\",\n     *       \"target\":\"PV:NAME:.*\",\n     *       \"regex\":true,\n     *       \"operator\":\"mean\",\n     *       \"alias\":\"$3\",\n     *       \"aliasPattern\":\"(.*):(.*)\",\n     *       \"functions\":[\n     *         {\n     *           \"text\":\"top($top_num, max)\",\n     *           \"params\":[ \"$top_num\", \"max\" ],\n     *           \"def\":{\n     *             \"category\":\"Filter Series\",\n     *             \"defaultParams\":[ 5, \"avg\" ],\n     *             \"name\":\"top\",\n     *             \"params\":[\n     *               { \"name\":\"number\", \"type\":\"int\" },\n     *               {\n     *                 \"name\":\"value\",\n     *                 \"options\":[ \"avg\", \"min\", \"max\", \"absoluteMin\", \"absoluteMax\", \"sum\" ],\n     *                 \"type\":\"string\"\n     *               }\n     *             ]\n     *           },\n     *         }\n     *       ],\n     *     }\n     *   ],\n     *   \"format\": \"json\",\n     *   \"maxDataPoints\": 2495 // decided by the panel\n     *   ...\n     * }\n     */\n    const query = { ...options };\n\n    // remove placeholder targets and undefined targets\n    query.targets = _.filter(query.targets, (target) => (\n      target.target !== '' && typeof target.target !== 'undefined'\n    ));\n\n    if (query.targets.length <= 0) {\n      return query;\n    }\n\n    const from = new Date(query.range.from);\n    const to = new Date(query.range.to);\n    const rangeMsec = to.getTime() - from.getTime();\n    const intervalSec = _.floor(rangeMsec / (query.maxDataPoints * 1000));\n\n    const interval = (intervalSec >= 1) ? String(intervalSec) : '';\n\n    const targets = _.map(query.targets, (target) => {\n      // Replace parameters with variables for each functions\n      const functions = _.map(target.functions, (func) => {\n        const newFunc = func;\n        newFunc.params = _.map(newFunc.params, (param) => (\n          this.templateSrv.replace(param, query.scopedVars, 'regex')\n        ));\n        return newFunc;\n      });\n\n      return {\n        target: this.templateSrv.replace(target.target, query.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        alias: this.templateSrv.replace(target.alias, query.scopedVars, 'regex'),\n        operator: this.templateSrv.replace(target.operator, query.scopedVars, 'regex'),\n        functions,\n        regex: target.regex,\n        aliasPattern: target.aliasPattern,\n        options: this.getOptions(target.functions),\n        from,\n        to,\n        interval,\n      };\n    });\n\n    query.targets = targets;\n\n    return query;\n  }\n\n  parseTargetPV(targetPV) {\n    /*\n     * ex) targetPV = ABC(1|2|3)EFG(5|6)\n     *     then\n     *     splitQueries = ['ABC','(1|2|3'), 'EFG', '(5|6)']\n     *     queries = [\n     *     ABC1EFG5, ABC1EFG6, ABC2EFG6,\n     *     ABC2EFG6, ABC3EFG5, ABC3EFG6\n     *     ]\n     */\n    const splitQueries = _.split(targetPV, /(\\(.*?\\))/);\n    let queries = [''];\n\n    _.forEach(splitQueries, (splitQuery, i) => {\n      // Fixed string like 'ABC'\n      if (i % 2 === 0) {\n        queries = _.map(queries, (query) => `${query}${splitQuery}`);\n        return;\n      }\n\n      // Regex OR string like '(1|2|3)'\n      const orElems = _.split(_.trim(splitQuery, '()'), '|');\n\n      const newQueries = _.map(queries, (query) => (\n        _.map(orElems, (orElem) => `${query}${orElem}`)\n      ));\n      queries = _.flatten(newQueries);\n    });\n\n    return queries;\n  }\n\n  applyFunctionDefs(functionDefs, categories, data) {\n    const applyFuncDefs = this.pickFuncDefsFromCategories(functionDefs, categories);\n\n    const promises = _.reduce(applyFuncDefs, (prevPromise, func) => (\n      prevPromise.then((res) => {\n        const funcInstance = aafunc.createFuncInstance(func.def, func.params);\n        const bindedFunc = funcInstance.bindFunction(dataProcessor.aaFunctions);\n\n        return Promise.resolve(bindedFunc(res));\n      })\n    ), Promise.resolve(data));\n\n    return promises;\n  }\n\n  getOptions(functionDefs) {\n    const appliedOptionFuncs = this.pickFuncDefsFromCategories(functionDefs, ['Options']);\n\n    const options = _.reduce(appliedOptionFuncs, (optionMap, func) => {\n      [optionMap[func.def.name]] = func.params;\n      return optionMap;\n    }, {});\n\n    return options;\n  }\n\n  pickFuncDefsFromCategories(functionDefs, categories) {\n    const allCategorisedFuncDefs = aafunc.getCategories();\n\n    const requiredCategoryFuncNames = _.reduce(categories, (funcNames, category) => (\n      _.concat(funcNames, _.map(allCategorisedFuncDefs[category], 'name'))\n    ), []);\n\n    const pickedFuncDefs = _.filter(functionDefs, (func) => (\n      _.includes(requiredCategoryFuncNames, func.def.name)\n    ));\n\n    return pickedFuncDefs;\n  }\n}\n"],"file":"datasource.js"}