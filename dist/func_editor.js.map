{"version":3,"sources":["../src/func_editor.ts"],"names":["aaFuncEditor","$compile","templateSrv","funcSpanTemplate","paramTemplate","restrict","link","postLink","$scope","elem","$funcLink","ctrl","func","scheduledRelink","paramCountAtLink","cancelBlur","handleRemoveFunction","removeFunction","handleMoveLeft","moveFunction","handleMoveRight","clickFuncParam","paramIndex","$link","$comma","prev","$input","next","val","params","removeClass","hide","show","focus","select","typeahead","data","lookup","scheduledRelinkIfNeeded","length","setTimeout","relink","paramDef","index","def","_","last","multiple","assign","optional","switchToLink","inputElem","clearTimeout","newValue","updateParam","html","highlightVariablesAsHtml","$apply","targetChanged","hasClass","addClass","inputBlur","inputKeyPress","e","which","blur","inputKeyDown","style","width","value","addTypeahead","attr","options","type","map","toString","source","minLength","items","updater","query","$element","process","addElementsAndCompile","appendTo","defParams","clone","lastParam","push","each","param","paramValue","hasValue","undefined","$paramLink","name","partial","keyup","keypress","click","contents","ifJustAddedFocusFirstParam","added","find","first","children","remove","coreModule","directive"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport coreModule from 'app/core/core_module';\nimport { TemplateSrv } from 'app/features/templating/template_srv';\n\n/** @ngInject */\nexport function aaFuncEditor($compile: any, templateSrv: TemplateSrv) {\n  const funcSpanTemplate = `\n    <function-editor\n      func=\"func\"\n      onRemove=\"ctrl.handleRemoveFunction\"\n      onMoveLeft=\"ctrl.handleMoveLeft\"\n      onMoveRight=\"ctrl.handleMoveRight\"\n    /><span>(</span>\n  `;\n  const paramTemplate =\n    '<input type=\"text\" style=\"display:none\"' + ' class=\"input-small tight-form-func-param\"></input>';\n\n  return {\n    restrict: 'A',\n    link: function postLink($scope: any, elem: JQuery) {\n      const $funcLink = $(funcSpanTemplate);\n      const ctrl = $scope.ctrl;\n      const func = $scope.func;\n      let scheduledRelink = false;\n      let paramCountAtLink = 0;\n      let cancelBlur: any = null;\n\n      ctrl.handleRemoveFunction = (func: any) => {\n        ctrl.removeFunction(func);\n      };\n\n      ctrl.handleMoveLeft = (func: any) => {\n        ctrl.moveFunction(func, -1);\n      };\n\n      ctrl.handleMoveRight = (func: any) => {\n        ctrl.moveFunction(func, 1);\n      };\n\n      function clickFuncParam(this: any, paramIndex: any) {\n        /*jshint validthis:true */\n\n        const $link = $(this);\n        const $comma = $link.prev('.comma');\n        const $input = $link.next();\n\n        $input.val(func.params[paramIndex]);\n\n        $comma.removeClass('query-part__last');\n        $link.hide();\n        $input.show();\n        $input.focus();\n        $input.select();\n\n        const typeahead = $input.data('typeahead');\n        if (typeahead) {\n          $input.val('');\n          typeahead.lookup();\n        }\n      }\n\n      function scheduledRelinkIfNeeded() {\n        if (paramCountAtLink === func.params.length) {\n          return;\n        }\n\n        if (!scheduledRelink) {\n          scheduledRelink = true;\n          setTimeout(() => {\n            relink();\n            scheduledRelink = false;\n          }, 200);\n        }\n      }\n\n      function paramDef(index: number) {\n        if (index < func.def.params.length) {\n          return func.def.params[index];\n        }\n        if ((_.last(func.def.params) as any).multiple) {\n          return _.assign({}, _.last(func.def.params), { optional: true });\n        }\n        return {};\n      }\n\n      function switchToLink(inputElem: HTMLElement, paramIndex: any) {\n        /*jshint validthis:true */\n        const $input = $(inputElem);\n\n        clearTimeout(cancelBlur);\n        cancelBlur = null;\n\n        const $link = $input.prev();\n        const $comma = $link.prev('.comma');\n        const newValue = $input.val();\n\n        // remove optional empty params\n        if (newValue !== '' || paramDef(paramIndex).optional) {\n          func.updateParam(newValue, paramIndex);\n          $link.html(newValue ? templateSrv.highlightVariablesAsHtml(newValue) : '&nbsp;');\n        }\n\n        scheduledRelinkIfNeeded();\n\n        $scope.$apply(() => {\n          ctrl.targetChanged();\n        });\n\n        if ($link.hasClass('query-part__last') && newValue === '') {\n          $comma.addClass('query-part__last');\n        } else {\n          $link.removeClass('query-part__last');\n        }\n\n        $input.hide();\n        $link.show();\n      }\n\n      // this = input element\n      function inputBlur(this: any, paramIndex: any) {\n        /*jshint validthis:true */\n        const inputElem = this;\n        // happens long before the click event on the typeahead options\n        // need to have long delay because the blur\n        cancelBlur = setTimeout(() => {\n          switchToLink(inputElem, paramIndex);\n        }, 200);\n      }\n\n      function inputKeyPress(this: any, paramIndex: any, e: any) {\n        /*jshint validthis:true */\n        if (e.which === 13) {\n          $(this).blur();\n        }\n      }\n\n      function inputKeyDown(this: any) {\n        /*jshint validthis:true */\n        this.style.width = (3 + this.value.length) * 8 + 'px';\n      }\n\n      function addTypeahead($input: any, paramIndex: any) {\n        $input.attr('data-provide', 'typeahead');\n\n        let options = paramDef(paramIndex).options;\n        if (paramDef(paramIndex).type === 'int') {\n          options = _.map(options, val => {\n            return val.toString();\n          });\n        }\n\n        $input.typeahead({\n          source: options,\n          minLength: 0,\n          items: 20,\n          updater: (value: any) => {\n            $input.val(value);\n            switchToLink($input[0], paramIndex);\n            return value;\n          },\n        });\n\n        const typeahead = $input.data('typeahead');\n        typeahead.lookup = function() {\n          this.query = this.$element.val() || '';\n          return this.process(this.source);\n        };\n      }\n\n      function addElementsAndCompile() {\n        $funcLink.appendTo(elem);\n\n        const defParams: any = _.clone(func.def.params);\n        const lastParam: any = _.last(func.def.params);\n\n        while (func.params.length >= defParams.length && lastParam && lastParam.multiple) {\n          defParams.push(_.assign({}, lastParam, { optional: true }));\n        }\n\n        _.each(defParams, (param: any, index: number) => {\n          if (param.optional && func.params.length < index) {\n            return false;\n          }\n\n          let paramValue = templateSrv.highlightVariablesAsHtml(func.params[index]);\n          const hasValue = paramValue !== null && paramValue !== undefined;\n\n          const last = index >= func.params.length - 1 && param.optional && !hasValue;\n          if (last && param.multiple) {\n            paramValue = '+';\n          }\n\n          if (index > 0) {\n            $('<span class=\"comma' + (last ? ' query-part__last' : '') + '\">, </span>').appendTo(elem);\n          }\n\n          const $paramLink = $(\n            '<a ng-click=\"\" class=\"graphite-func-param-link' +\n              (last ? ' query-part__last' : '') +\n              '\">' +\n              (hasValue ? paramValue : '&nbsp;') +\n              '</a>'\n          );\n          const $input = $(paramTemplate);\n          $input.attr('placeholder', param.name);\n\n          paramCountAtLink++;\n\n          $paramLink.appendTo(elem);\n          $input.appendTo(elem);\n\n          $input.blur(_.partial(inputBlur, index));\n          $input.keyup(inputKeyDown);\n          $input.keypress(_.partial(inputKeyPress, index));\n          $paramLink.click(_.partial(clickFuncParam, index));\n\n          if (param.options) {\n            addTypeahead($input, index);\n          }\n\n          return true;\n        });\n\n        $('<span>)</span>').appendTo(elem);\n\n        $compile(elem.contents())($scope);\n      }\n\n      function ifJustAddedFocusFirstParam() {\n        if ($scope.func.added) {\n          $scope.func.added = false;\n          setTimeout(() => {\n            elem\n              .find('.graphite-func-param-link')\n              .first()\n              .click();\n          }, 10);\n        }\n      }\n\n      function relink() {\n        elem.children().remove();\n        addElementsAndCompile();\n        ifJustAddedFocusFirstParam();\n      }\n\n      relink();\n    },\n  };\n}\n\ncoreModule.directive('aaFuncEditor', aaFuncEditor);\n"],"file":"func_editor.js"}